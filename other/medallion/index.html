<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medallion Hunt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet.MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Leaflet.MarkerCluster JavaScript -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script src="tailwind.config.js"></script>


    <!-- External Dependencies -->
    <!-- marked is markdown render-->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Header Section -->
    <header class="bg-white shadow-md py-4 mb-4 relative ">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between w-full">
                <a href='./?'><img src="img/logo.png" alt="Logo" class="h-20 w-auto mr-4" style="max-height: 4rem;"></a>
                <div class="flex-1 flex justify-center">
                    <h1 class="text-4xl font-bold text-gray-800 mb-1">Medallion Hunt</h1>
                </div>
                <button id="menuButton" class="p-2 hover:bg-gray-100 rounded-lg focus:outline-none ml-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
        <!-- Progress Bar -->
        <div id="medallion-progress-bar" class="w-full absolute left-0 bottom-0 h-3 flex z-10">
            <!-- Progress bar segments will be injected here -->
        </div>
    </header>

    <!-- Navigation Menu -->
    <div id="navMenu" class="fixed inset-0 bg-gray-800 bg-opacity-50 z-50 hidden">
        <div
            class="bg-white h-full w-64 shadow-lg transform transition-transform duration-300 ease-in-out -translate-x-full">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Navigation</h2>
                    <button id="closeMenu" class="p-2 hover:bg-gray-100 rounded-lg focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <nav class="p-2">
                <ul class="space-y-2 list-none">
                    <li>
                        <a href="#medallion-info"
                            class="block p-3 hover:bg-gray-100 rounded-lg flex items-center transition-colors duration-200 border border-transparent hover:border-gray-200">
                            <svg class="w-5 h-5 mr-3 text-blue-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-gray-700 font-medium">Medallion Information</span>
                        </a>
                    </li>
                    <li>
                        <a href="#project-info"
                            class="block p-3 hover:bg-gray-100 rounded-lg flex items-center transition-colors duration-200 border border-transparent hover:border-gray-200">
                            <svg class="w-5 h-5 mr-3 text-blue-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-gray-700 font-medium">About This Project</span>
                        </a>
                    </li>
                    <li>
                        <a href="#animal-info"
                            class="block p-3 hover:bg-gray-100 rounded-lg flex items-center transition-colors duration-200 border border-transparent hover:border-gray-200">
                            <svg class="w-5 h-5 mr-3 text-blue-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                            <span class="text-gray-700 font-medium">Animal Information</span>
                        </a>
                    </li>
                    <li>
                        <a href="#story"
                            class="block p-3 hover:bg-gray-100 rounded-lg flex items-center transition-colors duration-200 border border-transparent hover:border-gray-200">
                            <svg class="w-5 h-5 mr-3 text-blue-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                                </path>
                            </svg>
                            <span class="text-gray-700 font-medium">Story</span>
                        </a>
                    </li>
                    <li>
                        <a href="#medallion-map"
                            class="block p-3 hover:bg-gray-100 rounded-lg flex items-center transition-colors duration-200 border border-transparent hover:border-gray-200">
                            <svg class="w-5 h-5 mr-3 text-blue-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7">
                                </path>
                            </svg>
                            <span class="text-gray-700 font-medium">Medallion Map</span>
                        </a>
                    </li>
                    <li>
                        <a href="#Medallions index"
                            class="block p-3 hover:bg-gray-100 rounded-lg flex items-center transition-colors duration-200 border border-transparent hover:border-gray-200">
                            <svg class="w-5 h-5 mr-3 text-blue-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                </path>
                            </svg>
                            <span class="text-gray-700 font-medium">Medallions Index</span>
                        </a>
                    </li>
                    <li>
                        <a href="#medallion-stats"
                            class="block p-3 hover:bg-gray-100 rounded-lg flex items-center transition-colors duration-200 border border-transparent hover:border-gray-200">
                            <svg class="w-5 h-5 mr-3 text-blue-600" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                </path>
                            </svg>
                            <span class="text-gray-700 font-medium">Medallion Stats</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <main class="flex-grow container mx-auto px-4">
        <!-- Two-column layout for Medallion Info and About Project -->
        <div class="flex flex-col md:flex-row gap-4 mb-4">
            <!-- Medallion Information -->
            <div id="medallion-info" class="collapsible-section bg-white rounded-lg shadow-md flex-1"
                data-section="medallion-info">
                <div class="section-header flex justify-between items-center p-2 cursor-pointer">
                    <h2 class="text-2xl font-bold pl-2 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Medallion Information
                    </h2>
                    <button class="toggle-section p-2 hover:bg-gray-100 rounded-full">
                        <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                </div>
                <div class="section-content p-4">
                    <div id="result" class="space-y-1">
                    </div>
                    <div id="medallionDetails" class="mt-2 space-y-2">
                        <!-- Detailed medallion information will be populated here -->
                    </div>

                    <div class="mt-3">
                        <h3 class="text-lg font-semibold mb-2">‚úÖ Discovered Medallion</h3>
                        <div id="found-medallion-list" class="">loading Discovered medallions...</div>
                    </div>

                    <div class="mt-3">Go to the <a href='#medallion-map'>üó∫Ô∏è map</a> or <a href='#medallions-index'>üîé
                            clues</a> sections to find more medallions.</div>
                </div>
            </div>

            <!-- Project Information -->
            <div id="project-info" class="collapsible-section bg-white rounded-lg shadow-md flex-1"
                data-section="project-info">
                <div class="section-header flex justify-between items-center p-2 cursor-pointer">
                    <h2 class="text-2xl font-bold pl-2 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        About This Project
                    </h2>
                    <button class="toggle-section p-2 hover:bg-gray-100 rounded-full">
                        <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                </div>
                <div class="section-content p-4">
                    <div id="projectInfo" class="prose max-w-none">
                        <!-- Project information will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Animal Information -->
        <div id="animal-info" class="collapsible-section bg-white rounded-lg shadow-md mb-4" data-section="animal-info">
            <div class="section-header flex justify-between items-center p-2 cursor-pointer">
                <h2 class="text-2xl font-bold pl-2 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Animal Information
                </h2>
                <button class="toggle-section p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="section-content p-4">
                <div id="animalInfo" class="space-y-2">
                    <!-- Animal information will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Story -->
        <div id="story" class="collapsible-section bg-white rounded-lg shadow-md mb-4" data-section="story">
            <div class="section-header flex justify-between items-center p-2 cursor-pointer">
                <h2 class="text-2xl font-bold pl-2 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                        </path>
                    </svg>
                    Story
                </h2>
                <button class="toggle-section p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="section-content p-4">
                <div id="storyChapters" class="space-y-2">
                    <!-- Story chapters will be populated here -->
                </div>
            </div>
        </div>

        <!-- Medallion Map -->
        <div id="medallion-map" class="collapsible-section bg-white rounded-lg shadow-md mb-4"
            data-section="medallion-map">
            <div class="section-header flex justify-between items-center p-2 cursor-pointer">
                <h2 class="text-2xl font-bold pl-2 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7">
                        </path>
                    </svg>
                    Medallion Map
                </h2>
                <button class="toggle-section p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="section-content p-4">
                <div class="relative">
                    <div id="medallionMap" class="h-[300px] sm:h-[400px] md:h-[500px] rounded-lg"></div>
                    <button id="fullscreenButton"
                        class="absolute top-2 right-2 bg-white p-2 rounded-lg shadow-md hover:bg-gray-100 focus:outline-none z-[1000]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5">
                            </path>
                        </svg>
                    </button>
                </div>
                <div class="mt-4 flex items-center justify-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                        <span>Discovered</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                        <span>Available</span>
                    </div>

                </div>
            </div>
        </div>

        <!-- Discovered Medallions -->
        <div id="Medallions index" class="collapsible-section bg-white rounded-lg shadow-md mb-4"
            data-section="Medallions index">
            <div class="section-header flex justify-between items-center p-2 cursor-pointer">
                <h2 class="text-2xl font-bold pl-2 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                        </path>
                    </svg>
                    Medallions index
                </h2>
                <button class="toggle-section p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="section-content p-4">
                <div class="pb-4">
                    <h2>‚úÖ Discovered</h2>
                    <p>Medallions you have scanned and added to your collection</p>
                    <div id="found-medallion-list2" class="">Loading discovered medallions...</div>
                </div>

                <div>
                    <h2>üîç Available</h2>
                    <p>Medallions that you have found clues about, but have not found and scanned.</p>
                    <div id="available-medallion-list" class="">Loading available medallions...</div>
                </div>

                <div>
                    <h2>üîí Locked</h2>
                    <p>Medallions that you have not found any clues about to unlock</p>
                </div>
            </div>
        </div>

        <!-- Medallion Stats -->
        <div id="medallion-stats" class="collapsible-section bg-white rounded-lg shadow-md mb-4"
            data-section="medallion-stats">
            <div class="section-header flex justify-between items-center p-2 cursor-pointer">
                <h2 class="text-2xl font-bold pl-2 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                    Medallion Stats
                </h2>
                <button class="toggle-section p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="section-content p-4">
                <div id="stats" class="space-y-1">
                    <!-- Stats will be populated here -->
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="resetStorage"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Reset Progress
                    </button>
                </div>
            </div>
        </div>

        <!-- Diagnostic Dialog -->
        <div class="collapsible-section bg-yellow-50 border-2 border-yellow-200 rounded-lg shadow-md mb-8"
            data-section="diagnostic">
            <div class="section-header flex justify-between items-center p-4 cursor-pointer">
                <h2 class="text-xl font-bold text-yellow-800">Diagnostic Information (Development Only)</h2>
                <button class="toggle-section p-2 hover:bg-gray-100 rounded-full">
                    <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            <div class="section-content p-8">
                <div class="bg-white p-4 rounded">
                    <h3 class="font-semibold mb-2">Local Storage Contents:</h3>
                    <pre id="storageDisplay" class="text-sm font-mono whitespace-pre-wrap break-all"></pre>
                    <div id="availableLinks" class="mt-4">
                        <h3 class="font-semibold mb-2">Available Medallions:</h3>
                        <div class="grid grid-cols-2 gap-2" id="availableList">                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white shadow-md py-4 mt-4">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-500 text-sm mt-1">Version: 2025-June-15 @11:41pm</p>
            <div class="mt-2 space-x-4">
                <a href="about.html" class="text-blue-600 hover:underline">About</a>
            </div>
        </div>
    </footer>

    <script>
        /**
         * Medallion Hunt Application
         * A web application for tracking and managing medallion discoveries
         */

        // Constants
        const STORAGE_KEYS = {
            VISITED_MEDALLIONS: 'visitedMedallions',
            SECTION_STATES: 'sectionStates'
        };

        // Developer Settings
        const SETTINGS_DEVELOPER = false; // Set to true to enable developer features

        // Paths
        const SETTINGS_PATHS = {
            MEDALLION_MAP: './medallion-map.json',
            STORY_CHAPTER: './story/${chapterId}.md',
            ANIMAL_INFO: './animals/${animalId}.md',
            ANIMAL_MARKDOWN: './animals/${animalName}.md',
            STORY_FIRST_CHAPTER: './story/1-chapter.md',
            STORY_ANIMAL_CHAPTER: './story/${medallion.animal}.md',
            STORY_MILESTONE_CHAPTER: './story/${milestoneNumber}-chapter.md',
            INFO_PROJECT: './info.md',
            ABOUT_ANIMALS: './about-animals.md'
        };

        // Configure marked options for markdown parsing
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: true,
            mangle: false,
            sanitize: false
        });

        /**
         * UI Management
         */
        class UIManager {
            /**
             * Initialize collapsible sections
             */
            static initializeCollapsibleSections() {
                // Hide diagnostic section if developer mode is disabled
                const diagnosticSection = document.querySelector('[data-section="diagnostic"]');
                if (diagnosticSection) {
                    diagnosticSection.style.display = SETTINGS_DEVELOPER ? 'block' : 'none';
                }

                const sections = document.querySelectorAll('.collapsible-section');
                const savedStates = JSON.parse(localStorage.getItem(STORAGE_KEYS.SECTION_STATES) || '{}');

                sections.forEach(section => {
                    const sectionId = section.dataset.section;
                    const header = section.querySelector('.section-header');
                    const content = section.querySelector('.section-content');
                    const toggleButton = section.querySelector('.toggle-section');
                    const chevron = toggleButton.querySelector('svg');

                    const isCollapsed = savedStates[sectionId] || false;
                    if (isCollapsed) {
                        content.style.display = 'none';
                        chevron.classList.add('rotate-180');
                    }

                    header.addEventListener('click', () => {
                        const isCurrentlyCollapsed = content.style.display === 'none';
                        content.style.display = isCurrentlyCollapsed ? 'block' : 'none';
                        chevron.classList.toggle('rotate-180');

                        savedStates[sectionId] = !isCurrentlyCollapsed;
                        localStorage.setItem(STORAGE_KEYS.SECTION_STATES, JSON.stringify(savedStates));

                        // If this is the map section and it's being expanded, refresh the map
                        if (sectionId === 'medallion-map' && isCurrentlyCollapsed && window.medallionMap) {
                            setTimeout(() => {
                                window.medallionMap.invalidateSize();
                            }, 100);
                        }
                    });
                });
            }

            /**
             * Initialize navigation menu
             */
            static initializeNavigationMenu() {
                const menuButton = document.getElementById('menuButton');
                const closeMenu = document.getElementById('closeMenu');
                const navMenu = document.getElementById('navMenu');
                const menuLinks = navMenu.querySelectorAll('a');

                // Toggle menu
                menuButton.addEventListener('click', () => {
                    navMenu.classList.remove('hidden');
                    setTimeout(() => {
                        navMenu.querySelector('div').classList.remove('-translate-x-full');
                    }, 10);
                });

                closeMenu.addEventListener('click', () => {
                    navMenu.querySelector('div').classList.add('-translate-x-full');
                    setTimeout(() => {
                        navMenu.classList.add('hidden');
                    }, 300);
                });

                // Handle navigation
                menuLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = link.getAttribute('href').substring(1);
                        const targetSection = document.getElementById(targetId);

                        if (targetSection) {
                            // Close menu
                            navMenu.querySelector('div').classList.add('-translate-x-full');
                            setTimeout(() => {
                                navMenu.classList.add('hidden');
                            }, 300);

                            // Scroll to section
                            targetSection.scrollIntoView({ behavior: 'smooth' });

                            // Expand section if collapsed
                            const content = targetSection.querySelector('.section-content');
                            const chevron = targetSection.querySelector('.toggle-section svg');

                            if (content.style.display === 'none') {
                                content.style.display = 'block';
                                chevron.classList.remove('rotate-180');

                                // Update saved state
                                const savedStates = JSON.parse(localStorage.getItem(STORAGE_KEYS.SECTION_STATES) || '{}');
                                savedStates[targetSection.dataset.section] = false;
                                localStorage.setItem(STORAGE_KEYS.SECTION_STATES, JSON.stringify(savedStates));
                            }
                        }
                    });
                });

                // Close menu when clicking outside
                navMenu.addEventListener('click', (e) => {
                    if (e.target === navMenu) {
                        navMenu.querySelector('div').classList.add('-translate-x-full');
                        setTimeout(() => {
                            navMenu.classList.add('hidden');
                        }, 300);
                    }
                });
            }

            /**
             * Update the stats display
             * @param {Object} stats - The stats object containing counts
             */
            static updateStatsDisplay(stats) {
                const statsDiv = document.getElementById('stats');
                statsDiv.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-600">Total Medallions</p>
                            <p class="text-2xl font-bold">${stats.total}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-sm text-green-600">Discovered</p>
                            <p class="text-2xl font-bold text-green-600">${stats.discovered}</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <p class="text-sm text-blue-600">Available</p>
                            <p class="text-2xl font-bold text-blue-600">${stats.available}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-600">Locked </p>
                            <p class="text-2xl font-bold">${stats.locked}</p>
                        </div>
                    </div>
                `;
            }

            /**
             * Render the medallion progress bar in the header
             * @param {Object} stats - { discovered, available, locked, total }
             */
            static renderMedallionProgressBar(stats) {
                const bar = document.getElementById('medallion-progress-bar');
                if (!bar) return;
                const { discovered, available, locked, total } = stats;
                const discoveredPct = total ? (discovered / total) * 100 : 0;
                const availablePct = total ? (available / total) * 100 : 0;
                const lockedPct = total ? (total - (discovered + available)) / total * 100 : 0;
                const titleMouseOver = "Discovered: " + discovered +
                    ", Available: " + available +
                    ", Locked: " + locked +
                    ", Total: " + total;

                bar.innerHTML = `
                <div class="h-full bg-green-500" style="width: ${discoveredPct}%; transition: width 0.5s;" title="${titleMouseOver}"></div>
                <div class="h-full bg-blue-500" style="width: ${availablePct}%; transition: width 0.5s;" title="${titleMouseOver}"></div>
                <div class="h-full bg-gray-300" style="width: ${lockedPct}%; transition: width 0.5s;" title="${titleMouseOver}"></div>
                `;
                console.log(titleMouseOver);
            }

            /**
             * Update the diagnostic display
             */
            static updateDiagnosticDisplay() {
                if (!SETTINGS_DEVELOPER) return;

                const storageDisplay = document.getElementById('storageDisplay');
                const availableList = document.getElementById('availableList');

                if (storageDisplay) {
                    const visitedMedallions = DataManager.getVisitedMedallions();
                    storageDisplay.textContent = JSON.stringify(visitedMedallions, null, 2);
                }

                if (availableList) {
                    DataManager.loadMedallionMap().then(medallionMap => {
                        const visitedMedallions = DataManager.getVisitedMedallions();
                        const availableMedallions = medallionMap.filter(medallion =>
                            !visitedMedallions.includes(medallion.slug)
                        );

                        availableList.innerHTML = availableMedallions.map(medallion => `
                            <a href="?id=${medallion.slug}" 
                               class="text-blue-600 hover:text-blue-800 hover:underline">
                                ${medallion.animal}
                            </a>
                        `).join('');
                    }).catch(error => {
                        console.error('Error updating available list:', error);
                        availableList.innerHTML = '<p class="text-red-600">Error loading available medallions</p>';
                    });
                }
            }

            /**
             * Initialize the medallion map
             * @param {Array} medallionMap - The medallion map data
             * @param {Array} visitedMedallions - Array of visited medallion slugs
             */
            static initializeMedallionMap(medallionMap, visitedMedallions) {
                console.log('Initializing map...');

                // Ensure the map container exists
                let mapContainer = document.getElementById('medallionMap');
                if (!mapContainer) {
                    console.log('Creating map container...');
                    // Find the map section content
                    const mapSection = document.querySelector('#medallion-map .section-content');
                    if (!mapSection) {
                        console.error('Map section not found');
                        return;
                    }

                    // Create a wrapper div to hold both the map and the fullscreen button
                    const wrapper = document.createElement('div');
                    wrapper.className = 'relative';

                    // Create the map container
                    mapContainer = document.createElement('div');
                    mapContainer.id = 'medallionMap';
                    mapContainer.className = 'h-[300px] sm:h-[400px] md:h-[500px] rounded-lg';

                    // Create the fullscreen button
                    const fullscreenButton = document.createElement('button');
                    fullscreenButton.id = 'fullscreenButton';
                    fullscreenButton.className = 'absolute top-2 right-2 bg-white p-2 rounded-lg shadow-md hover:bg-gray-100 focus:outline-none z-[1000]';
                    fullscreenButton.innerHTML = `
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path>
                        </svg>
                    `;

                    // Add the map container and fullscreen button to the wrapper
                    wrapper.appendChild(mapContainer);
                    wrapper.appendChild(fullscreenButton);

                    // Create the legend
                    const legend = document.createElement('div');
                    legend.className = 'mt-4 flex items-center justify-center space-x-4';
                    legend.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                            <span>Discovered</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                            <span>Available</span>
                        </div>
                    `;

                    // Clear the section content and add our new elements
                    mapSection.innerHTML = '';
                    mapSection.appendChild(wrapper);
                    mapSection.appendChild(legend);
                }

                console.log('Map container:', mapContainer);

                // Clear existing map if it exists
                if (window.medallionMap) {
                    console.log('Removing existing map...');
                    window.medallionMap.remove();
                    window.medallionMap = null;
                }

                try {
                    console.log('Creating new map...');
                    // Initialize map centered on British Columbia
                    window.medallionMap = L.map('medallionMap', {
                        zoomControl: false, // Disable default zoom control
                        minZoom: 4, // Prevent zooming out too far
                        maxZoom: 18 // Prevent zooming in too far
                    }).setView([54.5, -125.5], 6);

                    console.log('Map created successfully');

                    // Add zoom control to the top left
                    L.control.zoom({
                        position: 'topleft'
                    }).addTo(window.medallionMap);

                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18
                    }).addTo(window.medallionMap);

                    // Fullscreen functionality
                    const fullscreenButton = document.getElementById('fullscreenButton');
                    const mapSection = mapContainer.closest('.section-content');
                    let isFullscreen = false;

                    fullscreenButton.addEventListener('click', () => {
                        if (!isFullscreen) {
                            // Enter fullscreen
                            mapSection.style.position = 'fixed';
                            mapSection.style.top = '0';
                            mapSection.style.left = '0';
                            mapSection.style.right = '0';
                            mapSection.style.bottom = '0';
                            mapSection.style.zIndex = '9999';
                            mapSection.style.backgroundColor = 'white';
                            mapSection.style.padding = '1rem';
                            mapContainer.style.height = 'calc(100vh - 2rem)';
                            fullscreenButton.innerHTML = `
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            `;
                        } else {
                            // Exit fullscreen
                            mapSection.style.position = '';
                            mapSection.style.top = '';
                            mapSection.style.left = '';
                            mapSection.style.right = '';
                            mapSection.style.bottom = '';
                            mapSection.style.zIndex = '';
                            mapSection.style.backgroundColor = '';
                            mapSection.style.padding = '';
                            mapContainer.style.height = '';
                            fullscreenButton.innerHTML = `
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path>
                                </svg>
                            `;
                        }
                        isFullscreen = !isFullscreen;
                        window.medallionMap.invalidateSize(); // Refresh map size
                    });

                    // Create marker clusters
                    const discoveredCluster = L.markerClusterGroup({
                        iconCreateFunction: function (cluster) {
                            return L.divIcon({
                                html: `<div class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center">${cluster.getChildCount()}</div>`,
                                className: 'custom-cluster',
                                iconSize: L.point(32, 32)
                            });
                        },
                        maxClusterRadius: 50, // Smaller radius for clustering
                        spiderfyOnMaxZoom: true, // Spread out markers when max zoom is reached
                        showCoverageOnHover: false, // Don't show coverage area on hover
                        zoomToBoundsOnClick: true, // Zoom to bounds when clicking a cluster
                        disableClusteringAtZoom: 15 // Disable clustering at high zoom levels
                    });

                    const availableCluster = L.markerClusterGroup({
                        iconCreateFunction: function (cluster) {
                            return L.divIcon({
                                html: `<div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center">${cluster.getChildCount()}</div>`,
                                className: 'custom-cluster',
                                iconSize: L.point(32, 32)
                            });
                        },
                        maxClusterRadius: 50, // Smaller radius for clustering
                        spiderfyOnMaxZoom: true, // Spread out markers when max zoom is reached
                        showCoverageOnHover: false, // Don't show coverage area on hover
                        zoomToBoundsOnClick: true, // Zoom to bounds when clicking a cluster
                        disableClusteringAtZoom: 15 // Disable clustering at high zoom levels
                    });

                    // Build available locations set
                    const availableLocations = new Set();
                    visitedMedallions.forEach(slugId => {
                        const medallion = DataManager.getMedallionBySlugId(medallionMap, slugId);
                        if (medallion) {
                            if (medallion.NextA) availableLocations.add(medallion.NextA);
                            if (medallion.NextB) availableLocations.add(medallion.NextB);
                            if (medallion.NextC) availableLocations.add(medallion.NextC);
                        }
                    });

                    // Add circles for each medallion
                    medallionMap.forEach(medallion => {
                        const coords = DataManager.convertLocationToCoordinates(medallion.location);
                        if (!coords) return;

                        // Skip locked medallions
                        if (!visitedMedallions.includes(medallion.slug) && !availableLocations.has(medallion.location)) {
                            return;
                        }

                        // Create a circle to show the search radius
                        const circle = L.circle([coords.lat, coords.lng], {
                            radius: 20, // 20 meters radius
                            color: visitedMedallions.includes(medallion.slug) ? '#22c55e' : '#3b82f6', // green for discovered, blue for available
                            fillColor: visitedMedallions.includes(medallion.slug) ? '#22c55e' : '#3b82f6',
                            fillOpacity: 0.2,
                            weight: 3 // Increased border thickness
                        });

                        // Create popup content
                        const popupContent = visitedMedallions.includes(medallion.slug) ?
                            // Discovered medallion popup
                            `<div class="p-2">
                                <h3 class="font-bold mb-1">${medallion.animal}</h3>
                                <p class="text-sm text-green-600 mb-2">‚úÖ Discovered</p>
                                <p class="text-sm mb-2">Location: ${medallion.location}</p>
                                <a href="?id=${medallion.slug}" 
                                   class="text-green-600 hover:text-green-700 hover:underline text-sm">
                                    View Medallion Details ‚Üí
                                </a>
                            </div>` :
                            // Available medallion popup
                            `<div class="p-2">
                                <h3 class="font-bold mb-1">Available Medallion</h3>
                                <p class="text-sm text-blue-600 mb-2">üîç Available to Find</p>
                                <p class="text-sm text-gray-600">Search within 20 meters of this location to find the hidden medallion.</p>
                            </div>`;
                        circle.bindPopup(popupContent);

                        // Add to appropriate cluster
                        if (visitedMedallions.includes(medallion.slug)) {
                            discoveredCluster.addLayer(circle);
                        } else {
                            availableCluster.addLayer(circle);
                        }
                    });

                    // Add clusters to map
                    window.medallionMap.addLayer(discoveredCluster);
                    window.medallionMap.addLayer(availableCluster);

                    // Fit map to show all markers
                    const bounds = L.latLngBounds(medallionMap
                        .map(m => DataManager.convertLocationToCoordinates(m.location))
                        .filter(coords => coords !== null)
                        .map(coords => [coords.lat, coords.lng]));

                    if (bounds.isValid()) {
                        window.medallionMap.fitBounds(bounds, { padding: [50, 50] });
                    }

                    console.log('Map initialization complete');
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            }
        }

        /**
         * Data Management
         */
        class DataManager {
            /**
             * Load the medallion map data
             * @returns {Promise<Array>} The medallion map data
             */
            static async loadMedallionMap() {
                try {
                    const response = await fetch(SETTINGS_PATHS.MEDALLION_MAP);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error loading medallion map:', error);
                    throw error;
                }
            }

            /**
             * Get medallion by slug ID
             * @param {Array} medallionMap - The medallion map data
             * @param {string} slugId - The slug ID to find
             * @returns {Object|null} The found medallion or null
             */
            static getMedallionBySlugId(medallionMap, slugId) {
                if (!medallionMap || !Array.isArray(medallionMap)) {
                    console.error('Invalid medallion map data:', medallionMap);
                    return null;
                }
                return medallionMap.find(item => item.slug === slugId);
            }


            /**
             * Get discovered medallions (those in local storage)
             * @param {Array} medallionMap
             * @returns {Array}
             */
            static getDiscoveredMedallions(medallionMap) {
                const visitedSlugs = this.getVisitedMedallions();
                return medallionMap.filter(m => visitedSlugs.includes(m.slug));
            }

            /**
             * Get available medallions (linked from discovered medallions)
             * @param {Array} medallionMap
             * @returns {Array}
             */
            static getAvailableMedallions(medallionMap) {
                // Available medallions are those whose slug matches any NextA/NextB/NextC of discovered medallions
                const discovered = this.getDiscoveredMedallions(medallionMap);
                const availableGPS = new Set();
                discovered.forEach(medallion => {
                    if (medallion && medallion.NextA) availableGPS.add(medallion.NextA);
                    if (medallion && medallion.NextB) availableGPS.add(medallion.NextB);
                    if (medallion && medallion.NextC) availableGPS.add(medallion.NextC);
                });

                // We got the GPS locations of the available medallions
                // We need to search the medallionMap to find 
                return medallionMap.filter(m =>
                    !this.getVisitedMedallions().includes(m.slug) &&
                    availableGPS.has(m.location)
                );
            }

            /**
             * Get locked medallions (not available or discovered)
             * @param {Array} medallionMap
             * @returns {Array}
             */
            static getLockedMedallions(medallionMap) {
                const discoveredSlugs = new Set(this.getDiscoveredMedallions(medallionMap).map(m => m.slug));
                const availableSlugs = new Set(this.getAvailableMedallions(medallionMap).map(m => m.slug));
                return medallionMap.filter(m =>
                    !discoveredSlugs.has(m.slug) &&
                    !availableSlugs.has(m.slug)
                );
            }


            /**
             * Get visited medallions from storage
             * @returns {Array} Array of visited medallion slugs
             */
            static getVisitedMedallions() {
                try {
                    return JSON.parse(localStorage.getItem(STORAGE_KEYS.VISITED_MEDALLIONS) || '[]');
                } catch (error) {
                    console.error('Error parsing visited medallions from storage:', error);
                    return [];
                }
            }

            /**
             * Add a medallion to visited storage
             * @param {string} slugId - The slug ID to add
             * @returns {boolean} Whether the medallion was newly added
             */
            static addVisitedMedallion(slugId) {
                const visitedMedallions = this.getVisitedMedallions();
                const isNew = !visitedMedallions.includes(slugId);

                if (isNew) {
                    visitedMedallions.push(slugId);
                    localStorage.setItem(STORAGE_KEYS.VISITED_MEDALLIONS, JSON.stringify(visitedMedallions));
                }

                return isNew;
            }

            /**
             * Reset all stored data
             */
            static resetStorage() {
                localStorage.removeItem(STORAGE_KEYS.VISITED_MEDALLIONS);
                localStorage.removeItem(STORAGE_KEYS.SECTION_STATES);
                // Clear URL parameters and reload
                window.history.replaceState({}, document.title, window.location.pathname);
                window.location.reload();
            }

            static async fetchMedallionData() {
                try {
                    const response = await fetch('./medallion-map.json');
                    if (!response.ok) throw new Error('Failed to fetch medallion data');
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching medallion data:', error);
                    return null;
                }
            }

            static async fetchStoryChapter(chapterId) {
                try {
                    const response = await fetch(SETTINGS_PATHS.STORY_CHAPTER.replace('${chapterId}', chapterId));
                    if (!response.ok) throw new Error(`Failed to fetch story chapter: ${chapterId}`);
                    return await response.text();
                } catch (error) {
                    console.error(`Error fetching story chapter ${chapterId}:`, error);
                    return null;
                }
            }

            static async fetchAnimalInfo(animalId) {
                try {
                    const response = await fetch(SETTINGS_PATHS.ANIMAL_INFO.replace('${animalId}', animalId));
                    if (!response.ok) throw new Error(`Failed to fetch animal info: ${animalId}`);
                    return await response.text();
                } catch (error) {
                    console.error(`Error fetching animal info ${animalId}:`, error);
                    return null;
                }
            }

            /**
             * Convert location string to coordinates
             * @param {string} location - Location string in various formats
             * @returns {Object|null} Object containing lat and lng, or null if invalid
             */
            static convertLocationToCoordinates(location) {
                if (!location || location === '????') return null;

                // Try to parse as "lat, lng" format
                const latLngMatch = location.match(/^\s*([-+]?\d*\.?\d+)\s*,\s*([-+]?\d*\.?\d+)\s*$/);
                if (latLngMatch) {
                    return {
                        lat: parseFloat(latLngMatch[1]),
                        lng: parseFloat(latLngMatch[2])
                    };
                }

                // Try to parse as "lat lng" format
                const spaceMatch = location.match(/^\s*([-+]?\d*\.?\d+)\s+([-+]?\d*\.?\d+)\s*$/);
                if (spaceMatch) {
                    return {
                        lat: parseFloat(spaceMatch[1]),
                        lng: parseFloat(spaceMatch[2])
                    };
                }

                // Try to parse as "lat¬∞ lng¬∞" format
                const degreeMatch = location.match(/^\s*([-+]?\d*\.?\d+)¬∞\s+([-+]?\d*\.?\d+)¬∞\s*$/);
                if (degreeMatch) {
                    return {
                        lat: parseFloat(degreeMatch[1]),
                        lng: parseFloat(degreeMatch[2])
                    };
                }

                // Try to parse as "lat¬∞N/S lng¬∞E/W" format
                const cardinalMatch = location.match(/^\s*([-+]?\d*\.?\d+)¬∞([NS])\s+([-+]?\d*\.?\d+)¬∞([EW])\s*$/);
                if (cardinalMatch) {
                    const lat = parseFloat(cardinalMatch[1]) * (cardinalMatch[2] === 'N' ? 1 : -1);
                    const lng = parseFloat(cardinalMatch[3]) * (cardinalMatch[4] === 'E' ? 1 : -1);
                    return { lat, lng };
                }

                return null;
            }
        }

        /**
         * Content Management
         */
        class ContentManager {
            /**
             * Load and display animal markdown content
             * @param {string} animalName - The name of the animal
             */
            static async loadAnimalMarkdown(animalName) {
                const animalInfoDiv = document.getElementById('animalInfo');
                try {
                    const response = await fetch(SETTINGS_PATHS.ANIMAL_MARKDOWN.replace('${animalName}', animalName));
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const markdown = await response.text();
                    const html = marked.parse(markdown);

                    animalInfoDiv.innerHTML = `
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <div class="markdown-content">
                                ${html}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading animal markdown:', error);
                    animalInfoDiv.innerHTML = `
                        <div class="bg-red-50 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold text-red-700 mb-3">Error Loading Animal Information</h3>
                            <p class="text-red-600">
                                Unable to load information for ${animalName}. The markdown file may not exist or there was an error loading it.
                            </p>
                        </div>
                    `;
                }
            }

            /**
             * Load and display story chapters
             */
            static async loadStoryChapters() {
                const storyChaptersDiv = document.getElementById('storyChapters');
                const visitedMedallions = DataManager.getVisitedMedallions();

                try {
                    const medallionMap = await DataManager.loadMedallionMap();
                    let chaptersHTML = '';
                    let chapterNumber = 1;

                    // Load Chapter 1 (Main Story Part 1)
                    try {
                        const milestoneResponse = await fetch(SETTINGS_PATHS.STORY_FIRST_CHAPTER, {
                            cache: 'no-store',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });

                        if (!milestoneResponse.ok) {
                            throw new Error('Main story chapter 1 is missing');
                        }

                        const milestoneMarkdown = await milestoneResponse.text();
                        chaptersHTML += this.createChapterHTML(chapterNumber, 'Main Story Part 1', milestoneMarkdown);
                        chapterNumber++;
                    } catch (error) {
                        console.error('Error loading first milestone chapter:', error);
                        chaptersHTML += this.createChapterHTML(chapterNumber, 'Main Story Part 1', 'Welcome to the Medallion Hunt! Discover medallions to unlock more of the story.');
                        chapterNumber++;
                    }

                    // Load animal chapters and milestone chapters
                    if (visitedMedallions.length > 0) {
                        for (let i = 0; i < visitedMedallions.length; i++) {
                            const slugId = visitedMedallions[i];
                            const medallion = DataManager.getMedallionBySlugId(medallionMap, slugId);

                            if (medallion) {
                                // Load animal chapter
                                try {
                                    const response = await fetch(SETTINGS_PATHS.STORY_ANIMAL_CHAPTER.replace('${medallion.animal}', medallion.animal), {
                                        cache: 'no-store',
                                        headers: {
                                            'Cache-Control': 'no-cache',
                                            'Pragma': 'no-cache'
                                        }
                                    });

                                    if (response.ok) {
                                        const markdown = await response.text();
                                        chaptersHTML += this.createChapterHTML(chapterNumber, medallion.animal, markdown);
                                        chapterNumber++;

                                        // Check if we need to load a milestone chapter (every 5 animals)
                                        if ((i + 1) % 5 === 0) {
                                            const milestoneNumber = Math.floor((i + 1) / 5) + 1;
                                            try {
                                                const milestoneResponse = await fetch(SETTINGS_PATHS.STORY_MILESTONE_CHAPTER.replace('${milestoneNumber}', milestoneNumber), {
                                                    cache: 'no-store',
                                                    headers: {
                                                        'Cache-Control': 'no-cache',
                                                        'Pragma': 'no-cache'
                                                    }
                                                });

                                                if (milestoneResponse.ok) {
                                                    const milestoneMarkdown = await milestoneResponse.text();
                                                    chaptersHTML += this.createChapterHTML(chapterNumber, `Main Story Part ${milestoneNumber}`, milestoneMarkdown);
                                                    chapterNumber++;
                                                }
                                            } catch (error) {
                                                console.error(`Error loading milestone chapter ${milestoneNumber}:`, error);
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error(`Error loading story for ${medallion.animal}:`, error);
                                }
                            }
                        }
                    }

                    storyChaptersDiv.innerHTML = chaptersHTML;
                    this.initializeChapterToggles();
                } catch (error) {
                    console.error('Error loading story chapters:', error);
                    storyChaptersDiv.innerHTML = `
                        <div class="bg-red-50 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold text-red-700 mb-3">Error Loading Story</h3>
                            <p class="text-red-600">Unable to load story chapters. Please try refreshing the page.</p>
                        </div>
                    `;
                }
            }

            /**
             * Create HTML for a story chapter
             * @param {number} chapterNumber - The chapter number
             * @param {string} title - The chapter title
             * @param {string} content - The chapter content
             * @returns {string} The chapter HTML
             */
            static createChapterHTML(chapterNumber, title, content) {
                const isMilestone = title.startsWith('Main Story Part');
                return `
                    <div class="story-chapter rounded-lg mb-2">
                        <div class="chapter-header flex justify-between items-center p-2 cursor-pointer hover:bg-gray-100 ${isMilestone ? 'bg-blue-100' : ''}">
                            <h3 class="text-xl font-bold">Chapter ${chapterNumber}: ${title}</h3>
                            <button class="toggle-chapter p-2 hover:bg-gray-200 rounded-full">
                                <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="chapter-content p-4 hidden">
                            <div class="markdown-content">
                                ${marked.parse(content)}
                            </div>
                        </div>
                    </div>
                `;
            }

            /**
             * Initialize chapter toggle functionality
             */
            static initializeChapterToggles() {
                document.querySelectorAll('.story-chapter').forEach(chapter => {
                    const header = chapter.querySelector('.chapter-header');
                    const content = chapter.querySelector('.chapter-content');
                    const toggleButton = chapter.querySelector('.toggle-chapter');
                    const chevron = toggleButton.querySelector('svg');

                    header.addEventListener('click', () => {
                        const isHidden = content.classList.contains('hidden');
                        content.classList.toggle('hidden');
                        chevron.classList.toggle('rotate-180');
                    });
                });
            }

            /**
             * Load and display about project content
             */
            static async loadAboutProject() {
                const projectInfoDiv = document.getElementById('projectInfo');
                try {
                    const response = await fetch(SETTINGS_PATHS.INFO_PROJECT);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const markdown = await response.text();
                    const html = marked.parse(markdown);

                    projectInfoDiv.innerHTML = html;
                } catch (error) {
                    console.error('Error loading about project:', error);
                    projectInfoDiv.innerHTML = `
                        <div class="bg-red-50 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold text-red-700 mb-3">Error Loading Project Information</h3>
                            <p class="text-red-600">
                                Unable to load project information. The markdown file may not exist or there was an error loading it.
                            </p>
                        </div>
                    `;
                }
            }

            /**
             * Load and display default animal information
             */
            static async loadDefaultAnimalInfo() {
                const animalInfoDiv = document.getElementById('animalInfo');
                try {
                    const response = await fetch(SETTINGS_PATHS.ABOUT_ANIMALS);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const markdown = await response.text();
                    const html = marked.parse(markdown);

                    animalInfoDiv.innerHTML = `
                        <div class="flex flex-col">
                            <div class="p-4 rounded-lg">
                                ${html}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading default animal info:', error);
                    animalInfoDiv.innerHTML = `
                        <div class="bg-red-50 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold text-red-700 mb-3">Error Loading Animal Information</h3>
                            <p class="text-red-600">
                                Unable to load default animal information. The markdown file may not exist or there was an error loading it.
                            </p>
                        </div>
                    `;
                }
            }
        }

        /**
         * Application State Management
         */
        class AppState {
            /**
             * Update the medallion display
             * @param {boolean} isNew - Whether this is a new discovery
             */
            static async updateMedallionDisplay(isNew = false) {
                try {
                    const medallionMap = await DataManager.loadMedallionMap();
                    const visitedMedallions = DataManager.getVisitedMedallions();
                    const urlParams = new URLSearchParams(window.location.search);
                    const currentSlugId = urlParams.get('id');

                    // Update current medallion details if available
                    if (currentSlugId) {
                        const currentMedallion = DataManager.getMedallionBySlugId(medallionMap, currentSlugId);
                        if (currentMedallion) {
                            const medallionDetails = document.getElementById('medallionDetails');
                            const resultDiv = document.getElementById('result');

                            // Update the result message
                            if (isNew) {
                                resultDiv.innerHTML = `
                                    <p class="text-lg text-gray-600">You've discovered the <strong>${currentMedallion.animal} medallion!</strong> üéâ</p>
                                `;
                            } else {
                                resultDiv.innerHTML = ``;
                            }

                            medallionDetails.innerHTML = `
                                <div class="p-4 rounded-lg">
                                    <div class="flex flex-col items-center mb-4">
                                        <div class="relative w-48 h-48 mb-4">
                                            <div class="absolute inset-0 rounded-full border-4 border-yellow-500 shadow-lg"></div>
                                            <img src="img/${currentMedallion.animal}.svg" 
                                                 alt="${currentMedallion.animal}" 
                                                 class="w-full h-full object-contain p-6"
                                                 onerror="this.src='img/placeholder.svg'">
                                        </div>
                                        <h3 class="text-lg font-semibold mb-2">${currentMedallion.animal}</h3>
                                    </div>
                                    <!-- 
                                    <div class="space-y-2">
                                        <p><span class="font-semibold">Slug ID:</span> ${currentMedallion.slug}</p>
                                        <p><span class="font-semibold">Location:</span> ${currentMedallion.location}</p>
                                        <p><span class="font-semibold">Next Locations:</span></p>
                                        <ul class="list-disc pl-6">
                                            <li>Next A: ${currentMedallion.NextA || 'None'}</li>
                                            <li>Next B: ${currentMedallion.NextB || 'None'}</li>
                                            <li>Next C: ${currentMedallion.NextC || 'None'}</li>
                                        </ul>
                                        <p><span class="font-semibold">Status:</span> 
                                            ${visitedMedallions.includes(currentMedallion.slug) ?
                                    '<span class="text-green-600">Discovered</span>' :
                                    '<span class="text-blue-600">Available</span>'}
                                        </p>
                                    </div>
                                    -->
                                </div>
                            `;
                        }
                    }

                    // Build available locations set
                    const availableLocations = new Set();
                    visitedMedallions.forEach(slugId => {
                        const medallion = DataManager.getMedallionBySlugId(medallionMap, slugId);
                        if (medallion) {
                            if (medallion.NextA) availableLocations.add(medallion.NextA);
                            if (medallion.NextB) availableLocations.add(medallion.NextB);
                            if (medallion.NextC) availableLocations.add(medallion.NextC);
                        }
                    });

                    // Prepare table data
                    const tableData = medallionMap.map(medallion => {
                        let status, statusText, statusClass, animal, location;

                        if (visitedMedallions.includes(medallion.slug)) {
                            status = '‚úÖ';
                            statusText = 'Discovered - Scanned and added to your collection';
                            statusClass = 'bg-green-100 text-green-800';
                            animal = medallion.animal;
                            location = medallion.location;
                        } else if (availableLocations.has(medallion.location)) {
                            status = 'üîç';
                            statusText = 'Available - Clues unlocked ‚Äî but not scanned yet';
                            statusClass = 'bg-blue-100 text-blue-800';
                            animal = medallion.animal;
                            location = medallion.location;
                        } else {
                            status = '‚è≥';
                            statusText = 'Locked - Coming soon ‚Äî hidden until you unlock the trail';
                            statusClass = 'bg-gray-100 text-gray-500';
                            animal = '????';
                            location = '????';
                        }

                        return {
                            status,
                            statusText,
                            statusClass,
                            animal,
                            location,
                            slug: medallion.slug
                        };
                    });

                    // Calculate stats
                    const stats = {
                        total: medallionMap.length,
                        discovered: visitedMedallions.length,
                        available: DataManager.getAvailableMedallions(medallionMap).length,
                        locked: DataManager.getLockedMedallions(medallionMap).length
                    };

                    // Update UI
                    UIManager.updateStatsDisplay(stats);
                    UIManager.initializeMedallionMap(medallionMap, visitedMedallions);
                    UIManager.renderMedallionProgressBar(stats);

                } catch (error) {
                    console.error('Error in updateMedallionDisplay:', error);
                    const tableBody = document.getElementById('medallionTableBody');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="px-4 py-2 border text-red-600 text-center">
                                Error loading medallion data. Please try refreshing the page.
                            </td>
                        </tr>
                    `;
                }
            }
        }



        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize UI components
            UIManager.initializeCollapsibleSections();
            UIManager.initializeNavigationMenu();

            // Set up event listeners
            document.getElementById('resetStorage').addEventListener('click', () => {
                if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                    DataManager.resetStorage();
                }
            });

            // Get the database
            const medallionMap = await DataManager.loadMedallionMap();

            // Load initial content
            await AppState.updateMedallionDisplay();
            await ContentManager.loadStoryChapters();
            await ContentManager.loadAboutProject();
            await ContentManager.loadDefaultAnimalInfo();
            UIManager.updateDiagnosticDisplay(); // Update diagnostic display if enabled

            // Load animal content if a specific medallion is selected
            const urlParams = new URLSearchParams(window.location.search);
            const currentSlugId = urlParams.get('id');
            if (currentSlugId) {
                const currentMedallion = DataManager.getMedallionBySlugId(medallionMap, currentSlugId);
                if (currentMedallion) {
                    // Add the medallion to visited storage when clicked
                    const isNew = DataManager.addVisitedMedallion(currentSlugId);
                    // Update the display to reflect the new discovery
                    await AppState.updateMedallionDisplay(isNew);
                    await ContentManager.loadAnimalMarkdown(currentMedallion.animal);
                    // Reload story chapters if this was a new discovery
                    if (isNew) {
                        await ContentManager.loadStoryChapters();
                    }
                    // Update diagnostic display if enabled
                    UIManager.updateDiagnosticDisplay();
                }
            }

            // Load the foundMedallionList
            const foundMedallionList = document.getElementById('found-medallion-list');
            const foundMedallionList2 = document.getElementById('found-medallion-list2');
            if (foundMedallionList && foundMedallionList2) {
                const visitedMedallions = DataManager.getVisitedMedallions();
                const found = visitedMedallions.map(slug => {
                    const medallion = medallionMap.find(m => m.slug === slug);
                    if (medallion) {
                        return `<a href="?id=${medallion.slug}" class="text-blue-600 hover:underline">${medallion.animal}</a>`;
                    } else {
                        return slug;
                    }
                });
                foundMedallionList.innerHTML = found.length > 0 ? found.join(', ') : '<span class="text-gray-400">None found yet</span>';
                foundMedallionList2.innerHTML = found.length > 0 ? found.join(', ') : '<span class="text-gray-400">None found yet</span>';

            }


            // available-medallion-list
            const availableMedallionList = document.getElementById('available-medallion-list');
            if (availableMedallionList) {
                const availableMedallions = DataManager.getAvailableMedallions(medallionMap);
                console.log("availableMedallions:", availableMedallions);

                let outputHTML = '';
                for (let i = 0; i < availableMedallions.length; i++) {
                    outputHTML += `<li>
                    <a href="https://www.google.com/maps/search/?api=1&query=${availableMedallions[i].location}" 
                        target="_blank" 
                        class="text-blue-600 hover:text-blue-800 hover:underline">${availableMedallions[i].location}</a><br />${availableMedallions[i].clue} 
                    </li>`
                }
                availableMedallionList.innerHTML = '<ul>' + outputHTML + '</ul>';
            }
        });
    </script>
</body>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JN7MW2BV0C"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-JN7MW2BV0C');
</script>

</html>